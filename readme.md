## Итоговый проект: Телеграм-боты. Стилизация изображений в телеграм-боте
## Deep Learning (семестр 1, осень 2021): базовый поток
## Stepik User ID: 295391604

Бот общается с пользователем  через InLine-клавиатуры. Так у пользователя запрашивается изображение, которое будет стилизовано (далее Фото), и  изображение, на основе которого будет выполнена стилизация (далее Стиль). Стиль может быть прислан пользователем или выбран им из предложенных(файлы s1.jpg, s2.jpg, s3.jpg,) . После получения файлов Фото и Стиль выполняется их корректировка (изменение размеров изображений до размера 256 (imsize  задано в MODEL_CONFIG.py)).  По завершении корректировки создается экземпляр класса Styler, экземпляр принимает  Фото и Стиль в качестве параметров инициалицации.  Далее вызывается метод экземпляра класса run_style_transfer, выполняющих перенос стиля в  соответствии с параметрами заданными в конструкторе экземпляра. Часть параметров конструктора инициализируются значениями из файла  model_config.py. После завершения работы метода run_style_transfer сохраняются веса, с которыми было выполнено преобразование, а также сохраняется полученное изображение. Изображение отправляется пользователю и далее возможны два варианта работы бота:
- возобновить преобразование уже переданных Фото и Стиль указав, какой из весов должен быть увеличен (+ 50000 - для стиля, +5 для Фото (значения эмпирические, носят иллюстративный характер*))
- начать новое преобразование с новыми Фото и Стиль

* повышение весов Фото или Стиля будет более заметно в случае, например, если перенос стиля привел к слишком сильному преобразованию Фото, и оно потеряло характерные признаки, примеры показан на рисунке
## Файлы бота
1) main.py - файл с основной логикой бота
2) styler.py - файл с классами нейронной сети
3) img_editor.py - содержит мотоды коррекции изображений(приводит к квадрату) и их преобразования  в тензоры и обратно
4) MODEL_CONFIG.py - файл конфигурации модели
5) BOT_CONFIG.py - файл конфигурации бота
tmp - каталог для хранения файлов пользователей, и предустановленных стилей

### main.py:
- создается экземпляр класса TeleBot
-  создается экземпляр класса Flask - app, который является сервисом запущенным на указанном CONFIG.PORT для  CONFIG.HOST. app необходим для реализации WEBHOOK, для корректного контекста которого были создан самоподписной сертификат и закрытый ключ, путь к которым указан в  CONFIG.CERT и CONFIG.CERT_KEY соответственно
- start_message - функция обработки команды /start. При необходимости удаляет результаты предыдущей работы пользователя
- switcher и switcher_add - обработчики нажатий кнопок клавиатур. switcher_add реагирует на выборы, которые в приводят к запуску image_corrector, switcher - на все остальные. Двумя обработчиками получилось более корректно убирать клавиатуры после нажатия
- get_user_img - функция, принимающая  файлы Фото и Стиля.
- image_corrector - функция бота, отвечающая за обработку изображений и перенос стиля. В ней выполняется коррекция файлов с помощью img_size_corrector, если файлы попали на обработку первый раз, а также добавление весов Фото и Стиля в случае последующих обработок. В ней создается экземпляр класса Styler и вызывается его метод переноса стилей run_style_transfer
- get_style_way - функция выбора способа определения файла Стиля (загружать или выбрать из предустановленных)
- copy_bot_style - копирует предустановленный стиль в Стиль пользователя
- file_checker - проверяет наличие файлов Фото и Стиля, запрашивает недостающие. Если оба файла обнаружены - вызывает image_corrector 
- save_params - сохраняет веса обработки Фото и Стиля
- load_patams - загружает веса предыдущей обработки Фото и Стиля
- img_size_corrector - выполняет корректировки размера и пропорций изображения с помощью методов объединенных в класс Img_editor
- send_welcome - функция реакции на команду /help
- echo_message - функция реакции на любое не предусмотренное ботом сообщение от пользователя 

### img_editor:
содержится класс Img_editor имеющий:
- параметр imsize, определяющий размер, к которому приводятся изображения
- метод image_loader приводит изображение к виду квадрата со стороной imsize и преобразует его в терзор
- метод image_unloader  выполняет преобразование из тензора в картинку

### styler.py
за основу взяты материалы [лекции](https://www.youtube.com/watch?v=u2HDm7YSwoA&t=2645s) 
из доработок:
все функции, которые были необходимы для выполнения переноса стиля, собраны в класс Styler, онже содержит параметры, которые определяют как и с чем работает сеть. Экземпляр класса инициализируется тензорами изображений Фото и Стиля, значения остальных параметров вынесены в MODEL_CONFIG.py (так удобнее менять). Оптимизатор оставлен  LBFGS, т.к. пробовала с Adam, AdamW скорость падения функций потерь была ниже, визуальный эффект - хуже. Добавлен метод weight_setter для правки весов при повторных обработках. run_style_transfer возвращает результат переноса Стиля на Фото и значения весов, они сохраняются save_params, и изменяются  при повторных обработках тех же Фото и Стиля 


### MODEL_CONFIG.py
#значения для нормализации каналов</br>
cnn_normalization_mean = torch.tensor([0.485, 0.456, 0.406])</br>
cnn_normalization_std = torch.tensor([0.229, 0.224, 0.225])</br>
#слои после которых добавляется ошибка Фото</br>
content_layers_default = ['conv_4']</br>
#слои после которых добавляется ошибка Стиля</br>
style_layers_default = ['conv_1', 'conv_2', 'conv_3', 'conv_4', 'conv_5']</br>
#размер, к которому приводятся стороны картинки</br>
imsize = 256</br>
#число эпох</br>
num_steps = 100</br>
#начальный вес Стиля</br>
style_weight = 1000000</br>
#начальный вес Фото</br>
content_weight = 2</br>


### BOT_CONFIG.py
содержит конфигурацию бота(токен) и сервера для установки webhook

